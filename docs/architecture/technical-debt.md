# 技术债务汇总

本文档整合了整个架构文档中提到的所有技术债务，供 AI 代理和开发人员参考。

## 优先级 1 - 安全（严重）

### 1. 硬编码加密密钥 🔴

**位置**：`src/utils/keyManager.js:10-12`

**问题**：
```javascript
export const SALT = Buffer.from('opensea-offer-maker-salt', 'utf8');
export const PASSWORD = 'opensea-offer-maker-password';
```
- 盐和密码在源代码中可见
- 任何有源代码的人都可以解密存储的密钥
- 所有用户默认使用相同的加密密钥

**影响**：
- 🔴 严重安全漏洞
- 用户资金可能面临风险
- 违反安全最佳实践

**解决方案**：
1. **短期**：强制用户设置 `ENCRYPTION_KEY` 环境变量
2. **中期**：首次运行时提示用户输入密码
3. **长期**：使用系统钥匙串或硬件钱包

**预估工作量**：2-3 天

---

### 2. 无依赖扫描 🔴

**问题**：
- 有漏洞的依赖可能未被发现
- CI 中无自动化安全扫描
- 无依赖更新自动化

**影响**：
- 潜在的安全漏洞
- 过时的包可能有已知漏洞

**解决方案**：
1. 在 CI 流水线中添加 `npm audit`
2. 配置 Dependabot 自动更新
3. 添加 Snyk 或类似工具

**预估工作量**：1-2 天

---

## 优先级 2 - 测试（高）

### 3. 测试覆盖率低 ⚠️

**当前状态**：
- 实际覆盖率：~60%
- 目标覆盖率：80%
- OfferStrategy 完全未测试
- KeyManager 安全功能未测试

**影响**：
- 回归风险高
- 难以安全重构
- 关键安全代码未验证

**未测试的关键区域**：
1. `src/services/offerStrategy.js` - 自动竞价逻辑
2. `src/utils/keyManager.js` - 加密/解密
3. 命令层集成测试
4. 错误处理路径

**解决方案**：
1. 为关键路径优先编写测试
2. 为 OfferStrategy 添加单元测试
3. 为 KeyManager 添加单元测试
4. 添加命令级集成测试

**预估工作量**：1-2 周

---

### 4. CI 中集成测试已禁用 ⚠️

**位置**：`.github/workflows/publish.yml:28`

**问题**：
```yaml
- name: Run integration tests
  if: false  # 已禁用
  run: npm run integration
```

**影响**：
- 集成回归可能到达生产环境
- API 集成未在 CI 中验证
- 仅单元测试在发布前运行

**解决方案**：
1. 在 GitHub Secrets 中配置测试 API 密钥
2. 启用集成测试（移除 `if: false`）
3. 使用测试网络进行区块链调用

**预估工作量**：1 天

---

### 5. 无 E2E 测试 ⚠️

**问题**：
- 命令级流程未端到端测试
- 无法验证完整用户旅程
- 手动测试容易出错

**影响**：
- CLI 使用体验可能存在回归
- 命令链未测试（如 key add → offer）

**解决方案**：
1. 添加 E2E 测试框架
2. 为关键流程编写 E2E 测试
3. 使用测试环境和模拟资金

**预估工作量**：1 周

---

## 优先级 3 - 代码质量（中）

### 6. 代码重复 - fetchWithRetry 🟡

**位置**：
- `src/services/openseaApi.js`
- `src/services/reservoirApi.js`

**问题**：
- 相同的重试逻辑在两处实现
- 违反 DRY 原则
- 更新需要修改多处

**影响**：
- 维护成本增加
- 不一致的行为风险

**解决方案**：
1. 提取到 `src/utils/apiUtils.js`
2. 创建通用 `fetchWithRetry` 函数
3. 两个 API 服务使用共享实现

**预估工作量**：2-3 小时

---

### 7. 日志不一致 🟡

**问题**：
- 大多数模块使用 logger
- `offerService.js` 使用 `console.log`
- 输出格式不一致

**位置**：`src/services/offerService.js`

**影响**：
- 日志输出不统一
- 难以过滤和解析日志
- 违反编码标准

**解决方案**：
1. 将所有 `console.log` 替换为 `logger.info/debug/error`
2. 添加 ESLint 规则禁止 console.log
3. 审查所有文件确保一致性

**预估工作量**：1-2 小时

---

### 8. 错误处理不一致 🟡

**问题**：
- 三种不同模式：
  1. throw（服务层）
  2. return null（策略层）
  3. process.exit（命令层）
- 无标准化策略
- 难以预测行为

**影响**：
- 混乱的错误传播
- 难以调试
- 新贡献者困惑

**解决方案**：
1. 文档化错误处理策略
2. 标准化每层的错误处理
3. 创建自定义 Error 类
4. 添加错误码系统

**预估工作量**：2-3 天

---

### 9. 硬编码配置 🟡

**问题**：
- 重试次数、延迟硬编码
- Gas 缓冲区硬编码
- RPC 提供商硬编码
- 魔法数字散布在代码中

**示例**：
```javascript
const retries = 3;  // 硬编码
const delay = 1000;  // 硬编码
const floorPriceLimit = 0.9;  // 硬编码在 offerStrategy.js
```

**影响**：
- 难以配置
- 用户无法自定义行为
- 测试困难

**解决方案**：
1. 创建 `src/config/defaults.js`
2. 移动所有配置常量
3. 允许环境变量覆盖
4. 添加配置验证

**预估工作量**：1 天

---

## 优先级 4 - 功能（低）

### 10. 自动竞价限制 🟢

**位置**：`src/services/offerStrategy.js`

**问题**：
- 一次只能监控一个集合
- 无暂停/恢复功能
- 使用 `process.exit(0)` 关闭
- 无状态持久化

**影响**：
- 功能受限
- 用户体验不佳
- 无法从中断恢复

**解决方案**：
1. 重新设计支持多集合监控
2. 添加暂停/恢复控制
3. 实现优雅关闭（信号处理）
4. 添加状态持久化

**预估工作量**：1-2 周

---

### 11. 无 RPC 故障转移 🟢

**位置**：`src/utils/commandUtils.js:44-47`

**问题**：
```javascript
const provider = new AlchemyProvider(networkName, ALCHEMY_API_KEY);
```
- Alchemy 硬编码为唯一 RPC 提供商
- Alchemy 宕机时无回退
- 无法使用替代提供商

**影响**：
- 单点故障
- 服务中断时工具不可用

**解决方案**：
1. 添加回退 RPC 提供商列表
2. 实现自动故障转移逻辑
3. 允许用户配置自定义 RPC
4. 添加提供商健康检查

**预估工作量**：2-3 天

---

### 12. 无 Linter 配置 🟢

**问题**：
- 无 ESLint 或 Prettier 配置
- 代码风格未强制执行
- 依赖手动代码审查

**影响**：
- 不一致的代码风格
- 潜在的代码质量问题
- 贡献者体验不佳

**解决方案**：
1. 添加 ESLint 配置
2. 添加 Prettier 配置
3. 配置 pre-commit hooks
4. 运行 `npm run lint` 在 CI 中

**预估工作量**：1 天

---

## 技术债务优先级矩阵

| 问题 | 优先级 | 影响 | 工作量 | 建议时间线 |
|------|--------|------|--------|-----------|
| 硬编码加密密钥 | P1 🔴 | 严重 | 2-3 天 | 立即 |
| 无依赖扫描 | P1 🔴 | 高 | 1-2 天 | 立即 |
| 测试覆盖率低 | P2 ⚠️ | 高 | 1-2 周 | 本月 |
| 集成测试禁用 | P2 ⚠️ | 中 | 1 天 | 本周 |
| 无 E2E 测试 | P2 ⚠️ | 中 | 1 周 | 本月 |
| 代码重复 | P3 🟡 | 低 | 2-3 小时 | 下次迭代 |
| 日志不一致 | P3 🟡 | 低 | 1-2 小时 | 下次迭代 |
| 错误处理不一致 | P3 🟡 | 中 | 2-3 天 | 下次冲刺 |
| 硬编码配置 | P3 🟡 | 低 | 1 天 | 下次冲刺 |
| 自动竞价限制 | P4 🟢 | 低 | 1-2 周 | 未来 |
| 无 RPC 故障转移 | P4 🟢 | 中 | 2-3 天 | 未来 |
| 无 Linter | P4 🟢 | 低 | 1 天 | 未来 |

## AI 代理指南

### 修改代码前

1. **检查此文档** - 了解是否触及债务区域
2. **评估影响** - 更改是否会使债务恶化？
3. **考虑改进** - 能否顺便解决债务？

### 安全修改的区域

✅ 可以安全修改（但要注意模式）：
- 单个命令文件（保持 CLI 接口）
- API 封装器（改进重试、错误处理）
- Logger（添加文件输出、改进格式）
- 测试（请添加更多！）

⚠️ 谨慎修改（关键文件）：
- `src/utils/keyManager.js` - 安全关键
- `src/services/offerStrategy.js` - 复杂逻辑
- `src/config.js` - 到处使用
- `.keys` 文件格式 - 用户破坏性变更

### 添加新功能时

**DO（应该做）**：
- 遵循现有模式（命令 → 服务 → API）
- 使用 logger（不是 console.log）
- 添加测试（争取 80% 覆盖率）
- 使用配置，避免硬编码
- 文档化公共 API

**DON'T（不应做）**：
- 添加新的硬编码值
- 绕过错误处理
- 跳过测试
- 引入新的代码重复
- 忽略安全考虑

## 债务偿还路线图

### 第 1 周（立即行动）
- [ ] 修复硬编码加密密钥
- [ ] 添加 npm audit 到 CI
- [ ] 启用集成测试
- [ ] 在 README 添加安全警告

### 第 2-4 周（本月）
- [ ] KeyManager 测试达到 80%
- [ ] OfferStrategy 测试达到 80%
- [ ] 提取共享的 fetchWithRetry
- [ ] 修复日志不一致

### 第 2-3 月（本季度）
- [ ] 添加 E2E 测试框架
- [ ] 标准化错误处理
- [ ] 添加 ESLint/Prettier
- [ ] 创建配置系统

### 第 4-6 月（未来）
- [ ] 重新设计自动竞价
- [ ] 添加 RPC 故障转移
- [ ] 系统钥匙串集成
- [ ] 硬件钱包支持

## 债务跟踪

**推荐工具**：
- GitHub Issues（带 "tech-debt" 标签）
- GitHub Projects（技术债务看板）
- 代码中的 TODO 注释（带 issue 链接）

**示例**：
```javascript
// TODO(#123): 重构以使用共享的 fetchWithRetry
// FIXME(#456): 硬编码重试次数应移至配置
// SECURITY(#789): 移除硬编码的加密密钥
```

## 度量和报告

**建议追踪**：
- 测试覆盖率趋势
- 技术债务 issues 数量
- 已解决 vs 新增债务
- 债务年龄（创建后的时间）

**月度审查**：
- 审查债务积压
- 优先级排序
- 分配给迭代
- 庆祝已偿还的债务！

---

**最后更新**：架构文档生成时
**负责人**：技术负责人 / 架构师
**审查周期**：每月
