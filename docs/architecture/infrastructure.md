# 基础设施和部署

## 基础设施即代码

- **工具**：无（无云基础设施）
- **位置**：无
- **方式**：通过 NPM 分发的 CLI 工具，无需基础设施配置

## 部署策略

### 部署方式

- **策略**：NPM 包发布（手动 + 自动化）
- **CI/CD 平台**：GitHub Actions
- **流水线配置**：`.github/workflows/publish.yml`

### 自动化工作流

发布流程：

1. 开发者推送匹配 `v*` 的 git 标签（如 `v0.0.7`）
2. GitHub Actions 工作流触发
3. 执行步骤：
   - 检出代码
   - 设置 Node.js 20.x
   - 运行 `npm ci`（从 lockfile 清洁安装）
   - 运行 `npm test`（仅单元测试）
   - ⚠️ 跳过集成测试（工作流中 `if: false`）
   - 运行 `npm publish --access public`
4. 几分钟内包在 NPM registry 可用

### 手动工作流

```bash
npm version patch  # 或 minor, major
git push --tags
npm publish --access public
```

## 环境

### 开发环境
- **位置**：本地开发者机器
- **运行方式**：`node src/cli.js` 本地执行
- **测试网络**：可使用测试网（Sepolia）
- **API 密钥**：建议使用独立的开发密钥

### 生产环境
- **位置**：用户机器（通过 NPM 安装）
- **安装方式**：全局安装 `npm install -g opensea-offer-maker`
- **运行方式**：使用用户的 API 密钥和私钥
- **区块链网络**：真实网络（Ethereum、Base）

**注意**：无暂存环境 - 发布的包直接提供给用户

## 环境提升流程

```
开发者机器 → Git Push → GitHub Actions → NPM Registry → 用户安装
                ↓
            创建标签 (v*)
                ↓
            测试通过（仅单元测试）
                ↓
            发布到 NPM
```

## 回滚策略

### 主要方法
NPM 版本回滚 + 文档说明

**流程**：
- 发现严重 bug 时，立即发布修复版本
- 从 NPM 取消发布损坏版本（72 小时内）
- 在 README 中更新关于损坏版本的警告

### 触发条件

- 发现严重安全漏洞
- 影响用户资金的数据丢失 bug
- 完全无法使用的 CLI 故障

### 恢复时间目标
2-4 小时

包括：
- 识别问题时间
- 开发/测试补丁时间
- 发布新版本时间
- 用户必须手动更新

**⚠️ 限制**：无自动回滚，用户必须手动更新

## 依赖的外部服务

### RPC 提供商
- **提供商**：Alchemy（硬编码依赖）
- **用途**：以太坊节点访问
- **配置**：用户提供 API 密钥
- **⚠️ 问题**：无回退提供商

### API 服务
1. **OpenSea API v2**
   - 用途：NFT 集合数据和出价
   - 需要 API 密钥

2. **Reservoir API**
   - 用途：跨市场数据
   - API 密钥可选（推荐）

### 部署目标
- **目标**：NPM Registry
- **访问**：需要 NPM 访问令牌（存储在 GitHub Secrets）
- **可见性**：公开包

## 监控和可观测性

- **状态**：未实现（CLI 工具特性）
- **日志**：本地控制台输出
- **指标**：无
- **追踪**：无
- **告警**：无

**说明**：作为 CLI 工具，在用户本地运行，无集中监控。

## 备份和灾难恢复

### 源代码
- **备份**：Git repository（GitHub）
- **频率**：每次提交
- **恢复**：`git clone`

### 用户数据
- **密钥文件**：`.keys`（用户机器本地）
- **备份责任**：用户自行备份
- **⚠️ 重要**：文档中应明确提醒用户备份 `.keys` 文件

### 配置
- **环境变量**：`.env` 文件（用户机器本地）
- **备份责任**：用户自行备份

**灾难恢复计划**：
- 源代码丢失：从 GitHub 恢复
- NPM 账户访问丢失：通过 NPM 支持恢复
- 用户密钥丢失：无法恢复（提醒用户备份）

## 扩展性考虑

- **不适用**：CLI 工具，无服务器组件
- **性能**：受限于用户机器和网络
- **并发**：一次一个命令执行

## 成本优化

- **基础设施成本**：$0（无云服务）
- **CI/CD 成本**：$0（GitHub Actions 免费层）
- **分发成本**：$0（NPM registry 免费）
- **API 成本**：由用户承担（使用自己的 API 密钥）
