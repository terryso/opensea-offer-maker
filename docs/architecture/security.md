# å®‰å…¨

## è¾“å…¥éªŒè¯

### éªŒè¯åº“
- **åº“**ï¼šæ— ï¼ˆæ‰‹åŠ¨éªŒè¯ï¼‰
- **éªŒè¯ä½ç½®**ï¼šå‘½ä»¤å±‚ï¼ˆå‚æ•°è§£æï¼‰å’ŒæœåŠ¡å±‚

### å¿…éœ€è§„åˆ™

| è¾“å…¥ç±»å‹ | éªŒè¯æ–¹æ³• | ä½ç½® |
|---------|---------|------|
| é“¾åç§° | å¯¹ç…§ `SUPPORTED_CHAINS` éªŒè¯ | `src/utils/commandUtils.js` |
| ç§é’¥ | é€šè¿‡ ethers.js éªŒè¯ï¼ˆæ— æ•ˆåˆ™æŠ›å‡ºï¼‰ | `src/utils/keyManager.js` |
| åœ°å€ | é€šè¿‡ ethers.js `isAddress()` | å„å‘½ä»¤æ–‡ä»¶ |
| é‡‘é¢ | éªŒè¯ä¸ºæ­£æ•° | å„å‘½ä»¤æ–‡ä»¶ |
| é›†åˆ slug | å­—ç¬¦ä¸²éç©ºæ£€æŸ¥ | å„å‘½ä»¤æ–‡ä»¶ |

### éªŒè¯ç¤ºä¾‹

```javascript
// é“¾éªŒè¯
import { SUPPORTED_CHAINS } from '../config.js';

function validateChain(chainName) {
  const chain = SUPPORTED_CHAINS.find(c => c.name === chainName);
  if (!chain) {
    throw new Error(`Unsupported chain: ${chainName}`);
  }
  return chain;
}

// åœ°å€éªŒè¯
import { isAddress } from 'ethers';

function validateAddress(address) {
  if (!isAddress(address)) {
    throw new Error(`Invalid Ethereum address: ${address}`);
  }
  return address;
}

// é‡‘é¢éªŒè¯
function validateAmount(amount) {
  const num = parseFloat(amount);
  if (isNaN(num) || num <= 0) {
    throw new Error('Amount must be a positive number');
  }
  return amount;
}
```

**âš ï¸ æœ‰é™éªŒè¯**ï¼š
- æ— è¾“å…¥æ¸…ç†ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
- æ—  SQL æ³¨å…¥é£é™©ï¼ˆæ— æ•°æ®åº“ï¼‰

## è®¤è¯å’Œæˆæƒ

### è®¤è¯æ–¹æ³•
- **æ–¹æ³•**ï¼šæœ¬åœ°ç§é’¥ï¼ˆæ— è¿œç¨‹è®¤è¯ï¼‰
- **ä¼šè¯ç®¡ç†**ï¼šä¸é€‚ç”¨ï¼ˆCLI å·¥å…·ï¼Œæ— ä¼šè¯ï¼‰

### å¿…éœ€æ¨¡å¼

1. **å¯†é’¥ç®¡ç†**
   - ç”¨æˆ·å¿…é¡»é€šè¿‡ `key add` å‘½ä»¤æ·»åŠ ç§é’¥åæ‰èƒ½è¿›è¡Œäº¤æ˜“
   - è‡ªåŠ¨é€‰æ‹©æ´»è·ƒå¯†é’¥ï¼Œæˆ–ä½¿ç”¨ `--private-key` æ ‡å¿—æŒ‡å®š
   - æ— è¿œç¨‹è®¤è¯ - å·¥å…·ä½œä¸ºç”¨æˆ·é’±åŒ…

2. **API å¯†é’¥**
   - OpenSea API å¯†é’¥ï¼šé€šè¿‡ç¯å¢ƒå˜é‡
   - Alchemy API å¯†é’¥ï¼šé€šè¿‡ç¯å¢ƒå˜é‡
   - æ— ä¸­å¤®è®¤è¯æœåŠ¡å™¨

## å¯†é’¥ç®¡ç†

### å¼€å‘ç¯å¢ƒ
- **æ–¹å¼**ï¼š`.env` æ–‡ä»¶ï¼ˆå¿…é¡»æ‰‹åŠ¨åˆ›å»ºï¼Œgitignoredï¼‰
- **å†…å®¹**ï¼š
  ```
  OPENSEA_API_KEY=your_key_here
  ALCHEMY_API_KEY=your_key_here
  ENCRYPTION_KEY=optional_custom_key
  ```

### ç”Ÿäº§ç¯å¢ƒ
- **æ–¹å¼**ï¼šç›¸åŒï¼ˆç”¨æˆ·æœºå™¨ä¸Šçš„ `.env` æ–‡ä»¶ï¼‰
- **è´£ä»»**ï¼šç”¨æˆ·è´Ÿè´£ä¿æŠ¤å…¶ API å¯†é’¥

### ä»£ç è¦æ±‚

**âœ… åº”è¯¥åš**ï¼š
- ä»…ä»ç¯å¢ƒåŠ è½½ API å¯†é’¥
- ç§é’¥å­˜å‚¨å‰åŠ å¯†
- æ—¥å¿—ä¸­ä¸è®°å½•å¯†é’¥ï¼ˆä»…è®°å½•åœ°å€ï¼‰

**âš ï¸ è¿è§„**ï¼š
```javascript
// src/utils/keyManager.js:10-12
export const SALT = Buffer.from('opensea-offer-maker-salt', 'utf8');
export const PASSWORD = 'opensea-offer-maker-password';
```
æºä»£ç ä¸­ç¡¬ç¼–ç çš„ç›å’Œå¯†ç æ„å‘³ç€ä»»ä½•æœ‰æºä»£ç çš„äººéƒ½å¯ä»¥è§£å¯†å­˜å‚¨çš„ç§é’¥ã€‚

### å¯ç”¨çš„ç¼“è§£æªæ–½
è®¾ç½® `ENCRYPTION_KEY` ç¯å¢ƒå˜é‡ï¼š
```bash
export ENCRYPTION_KEY="your-secure-password-here"
```

### å»ºè®®
1. é¦–æ¬¡ä½¿ç”¨æ—¶æç¤ºç”¨æˆ·è¾“å…¥å¯†ç 
2. ä½¿ç”¨ç³»ç»Ÿé’¥åŒ™ä¸²å­˜å‚¨å¯†é’¥
3. æˆ–æ˜ç¡®æ–‡æ¡£è¯´æ˜ï¼š"ä»…ç”¨äºä½ä»·å€¼é’±åŒ…"

## âš ï¸ ä¸¥é‡å®‰å…¨é—®é¢˜

### é—®é¢˜ï¼šç¡¬ç¼–ç åŠ å¯†å¯†é’¥

**ä½ç½®**ï¼š`src/utils/keyManager.js:10-12`

```javascript
export const SALT = Buffer.from('opensea-offer-maker-salt', 'utf8');
export const PASSWORD = 'opensea-offer-maker-password';
```

**å½±å“**ï¼š
- ä»»ä½•æœ‰æºä»£ç è®¿é—®æƒé™çš„äººéƒ½å¯ä»¥è§£å¯† `.keys` æ–‡ä»¶
- æ‰€æœ‰æœªè‡ªå®šä¹‰ `ENCRYPTION_KEY` çš„ç”¨æˆ·éƒ½ä½¿ç”¨ç›¸åŒçš„åŠ å¯†å¯†é’¥
- ä¸¥é‡çš„å®‰å…¨æ¼æ´

**é£é™©ç­‰çº§**ï¼šğŸ”´ ä¸¥é‡

**ç¼“è§£æªæ–½**ï¼š
1. **ä¸´æ—¶**ï¼šç”¨æˆ·è®¾ç½® `ENCRYPTION_KEY` ç¯å¢ƒå˜é‡
2. **æ°¸ä¹…**ï¼šé‡æ„ä»¥ä½¿ç”¨ï¼š
   - é¦–æ¬¡è¿è¡Œæ—¶çš„ç”¨æˆ·ç”Ÿæˆå¯†ç 
   - ç³»ç»Ÿé’¥åŒ™ä¸²é›†æˆ
   - ç¡¬ä»¶é’±åŒ…æ”¯æŒ

**ç”¨æˆ·è­¦å‘Š**ï¼š
åœ¨ README ä¸­æ˜ç¡®è¯´æ˜ï¼š
> âš ï¸ è­¦å‘Šï¼šä»…ä½¿ç”¨ä½ä»·å€¼é’±åŒ…ã€‚å§‹ç»ˆè®¾ç½®è‡ªå®šä¹‰ ENCRYPTION_KEYã€‚

## API å®‰å…¨

### é€Ÿç‡é™åˆ¶
- **å®¢æˆ·ç«¯å®ç°**ï¼šæœªå®ç°ï¼ˆä¾èµ– API æä¾›å•†é™åˆ¶ï¼‰
- **CORS ç­–ç•¥**ï¼šä¸é€‚ç”¨ï¼ˆé Web æœåŠ¡å™¨ï¼‰
- **å®‰å…¨æ ‡å¤´**ï¼šä¸é€‚ç”¨ï¼ˆé Web æœåŠ¡å™¨ï¼‰
- **HTTPS å¼ºåˆ¶**ï¼šæ‰€æœ‰å¤–éƒ¨ API ä½¿ç”¨ HTTPSï¼ˆfetch åŸç”Ÿæ”¯æŒï¼‰

### API ç«¯ç‚¹å®‰å…¨

| API | è®¤è¯æ–¹æ³• | å®‰å…¨æªæ–½ |
|-----|---------|---------|
| OpenSea v2 | `X-API-KEY` header | HTTPS, API å¯†é’¥åœ¨ç¯å¢ƒä¸­ |
| Reservoir | `x-api-key` headerï¼ˆå¯é€‰ï¼‰ | HTTPS |
| Alchemy RPC | URL ä¸­çš„ API å¯†é’¥ | HTTPS |

## æ•°æ®ä¿æŠ¤

### é™æ€åŠ å¯†
- **ç§é’¥**ï¼šä½¿ç”¨ AES-256-GCM åŠ å¯†
- **ç®—æ³•**ï¼šAES-256-GCMï¼ˆè®¤è¯åŠ å¯†ï¼‰
- **å¯†é’¥æ´¾ç”Ÿ**ï¼šscrypt(password, salt, 32)
- **å­˜å‚¨æ ¼å¼**ï¼šJSON æ–‡ä»¶ï¼Œæ¯ä¸ªå¯†é’¥ç‹¬ç«‹çš„ IV å’Œè®¤è¯æ ‡ç­¾

#### åŠ å¯†å®ç°

æ¥æºï¼š`src/utils/keyManager.js`

```javascript
import crypto from 'crypto';

// åŠ å¯†æµç¨‹
const algorithm = 'aes-256-gcm';
const iv = crypto.randomBytes(16);
const key = crypto.scryptSync(password, salt, 32);

const cipher = crypto.createCipheriv(algorithm, key, iv);
let encrypted = cipher.update(privateKey, 'utf8', 'hex');
encrypted += cipher.final('hex');
const authTag = cipher.getAuthTag();

// å­˜å‚¨æ ¼å¼
{
  "wallet-name": {
    "encryptedKey": "hex_string",
    "authTag": "hex_string",
    "iv": "hex_string",
    "address": "0x...",
    "isActive": true
  }
}
```

### ä¼ è¾“ä¸­åŠ å¯†
- **æ–¹æ³•**ï¼šæ‰€æœ‰ API è°ƒç”¨ä½¿ç”¨ HTTPS
- **å®ç°**ï¼šfetch API åŸç”Ÿæ”¯æŒ

### PII å¤„ç†
- **é’±åŒ…åœ°å€**ï¼šè®°å½•ï¼ˆåœ¨åŠ å¯†é¢†åŸŸè§†ä¸ºå…¬å¼€ä¿¡æ¯ï¼‰
- **ç§é’¥**ï¼šæ°¸ä¸è®°å½•
- **API å¯†é’¥**ï¼šä¸è®°å½•

### æ—¥å¿—é™åˆ¶

```javascript
// âœ… å®‰å…¨
logger.info('Creating offer from wallet:', wallet.address);
logger.debug('Using key:', key.slice(0, 6) + '...' + key.slice(-4));

// âŒ ä¸å®‰å…¨
logger.debug('Private key:', privateKey);  // æ°¸è¿œä¸è¦è¿™æ ·åšï¼
logger.debug('API key:', apiKey);          // æ°¸è¿œä¸è¦è¿™æ ·åšï¼
```

## ä¾èµ–å®‰å…¨

### æ‰«æå·¥å…·
- **å½“å‰**ï¼šæ— é…ç½®ï¼ˆåº”æ·»åŠ  npm audit æˆ– Snykï¼‰
- **æ›´æ–°ç­–ç•¥**ï¼šæ‰‹åŠ¨æ›´æ–°ï¼ˆæ— è‡ªåŠ¨åŒ–ä¾èµ–æ›´æ–°ï¼‰
- **å®¡æ‰¹æµç¨‹**ï¼šæ— æ­£å¼æµç¨‹ï¼ˆå¼€æºï¼Œæ¥å—ç¤¾åŒºè´¡çŒ®ï¼‰

**âš ï¸ å·®è·**ï¼šCI ä¸­æ— è‡ªåŠ¨åŒ–ä¾èµ–æ¼æ´æ‰«æ

### å»ºè®®é…ç½®

```yaml
# .github/workflows/security.yml
name: Security Scan
on: [push, pull_request]
jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm audit
      - run: npm audit fix  # è‡ªåŠ¨ä¿®å¤
```

## å®‰å…¨æµ‹è¯•

### SASTï¼ˆé™æ€åº”ç”¨å®‰å…¨æµ‹è¯•ï¼‰
- **å·¥å…·**ï¼šæ— ï¼ˆåº”æ·»åŠ  ESLint å®‰å…¨æ’ä»¶ï¼‰
- **å»ºè®®**ï¼š
  ```bash
  npm install --save-dev eslint-plugin-security
  ```

### DASTï¼ˆåŠ¨æ€åº”ç”¨å®‰å…¨æµ‹è¯•ï¼‰
- **å·¥å…·**ï¼šä¸é€‚ç”¨ï¼ˆé Web åº”ç”¨ï¼‰

### æ¸—é€æµ‹è¯•
- **çŠ¶æ€**ï¼šæ— ï¼ˆå¼€æºå·¥å…·ï¼Œç¤¾åŒºå®¡æŸ¥ï¼‰

## å®‰å…¨å»ºè®®

### ç«‹å³è¡ŒåŠ¨ï¼ˆä¼˜å…ˆçº§ 1ï¼‰
1. âœ… ä¿®å¤ç¡¬ç¼–ç åŠ å¯†å¯†é’¥é—®é¢˜
   - ç§»é™¤ç¡¬ç¼–ç çš„ SALT å’Œ PASSWORD
   - å¼ºåˆ¶ç”¨æˆ·è®¾ç½® ENCRYPTION_KEY
   - æˆ–é¦–æ¬¡è¿è¡Œæ—¶æç¤ºè¾“å…¥å¯†ç 

2. âœ… åœ¨ CI ä¸­æ·»åŠ  `npm audit`
   - æ¯æ¬¡æ¨é€æ—¶æ‰«ææ¼æ´
   - é˜»æ­¢æœ‰ä¸¥é‡æ¼æ´çš„éƒ¨ç½²

3. âœ… åœ¨ README ä¸­æ·»åŠ å®‰å…¨è­¦å‘Š
   - ä»…ç”¨äºä½ä»·å€¼é’±åŒ…
   - å¿…é¡»è®¾ç½® ENCRYPTION_KEY
   - å¤‡ä»½ `.keys` æ–‡ä»¶çš„é‡è¦æ€§

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
4. æ·»åŠ  ESLint å®‰å…¨æ’ä»¶
5. å®ç°ä¾èµ–æ›´æ–°è‡ªåŠ¨åŒ–ï¼ˆDependabotï¼‰
6. ä¸ºå¯†é’¥æ“ä½œæ·»åŠ å®¡è®¡æ—¥å¿—

### ä¸­æœŸï¼ˆ1-2 æœˆï¼‰
7. æ¢ç´¢ç³»ç»Ÿé’¥åŒ™ä¸²é›†æˆ
8. æ·»åŠ ç¡¬ä»¶é’±åŒ…æ”¯æŒ
9. å®ç°å¤šé‡ç­¾åæ”¯æŒ
10. æ·»åŠ äº¤æ˜“æ¨¡æ‹Ÿé¢„è§ˆ

### é•¿æœŸï¼ˆ3-6 æœˆï¼‰
11. å®‰å…¨å®¡è®¡ï¼ˆå¤–éƒ¨ï¼‰
12. Bug èµé‡‘è®¡åˆ’
13. å½¢å¼åŒ–éªŒè¯å…³é”®ä»£ç è·¯å¾„

## å®‰å…¨æ£€æŸ¥æ¸…å•

åœ¨éƒ¨ç½²å‰æ£€æŸ¥ï¼š

- [ ] æ— ç¡¬ç¼–ç å¯†é’¥æˆ–å¯†ç 
- [ ] æ‰€æœ‰å¯†é’¥ä»ç¯å¢ƒåŠ è½½
- [ ] ç§é’¥åŠ å¯†åå­˜å‚¨
- [ ] æ—¥å¿—ä¸­æ— æ•æ„Ÿæ•°æ®
- [ ] ä½¿ç”¨ HTTPS è¿›è¡Œæ‰€æœ‰å¤–éƒ¨è°ƒç”¨
- [ ] è¾“å…¥éªŒè¯å·²å®ç°
- [ ] ä¾èµ–é¡¹æ˜¯æœ€æ–°çš„
- [ ] `npm audit` é€šè¿‡æ— ä¸¥é‡é—®é¢˜
- [ ] å®‰å…¨æ–‡æ¡£æ˜¯æœ€æ–°çš„
- [ ] README åŒ…å«å®‰å…¨æœ€ä½³å®è·µ

## å®‰å…¨è”ç³»

- **æ¼æ´æŠ¥å‘Š**ï¼š[GitHub Issues](https://github.com/your-repo/issues)ï¼ˆç§å¯†æŠ¥å‘Šï¼‰
- **å®‰å…¨æ”¿ç­–**ï¼šå¾…æ·»åŠ  SECURITY.md
- **å“åº”æ—¶é—´**ï¼šå°½åŠ›è€Œä¸ºï¼ˆå¼€æºé¡¹ç›®ï¼‰

## åˆè§„æ€§

- **é€‚ç”¨æ³•è§„**ï¼šæ— ï¼ˆä¸ªäººä½¿ç”¨å·¥å…·ï¼‰
- **æ•°æ®é©»ç•™**ï¼šæœ¬åœ°ï¼ˆç”¨æˆ·æœºå™¨ï¼‰
- **å®¡è®¡è¦æ±‚**ï¼šæ— 
- **éšç§æ”¿ç­–**ï¼šæ— ï¼ˆä¸æ”¶é›†ç”¨æˆ·æ•°æ®ï¼‰

**æ³¨æ„**ï¼šä½œä¸ºæœ¬åœ° CLI å·¥å…·ï¼Œæ— æ•°æ®æ”¶é›†æˆ–è¿œç¨‹å­˜å‚¨ã€‚
