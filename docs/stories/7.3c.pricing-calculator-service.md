# Story 7.3c: PricingCalculator Service - Price Calculation and Fee Logic

## Status
Draft

## Story
**As a** developer,
**I want** a dedicated PricingCalculator service to handle all price calculation and fee breakdown logic,
**so that** pricing operations are centralized, accurate, and easy to maintain across different listing scenarios

## Acceptance Criteria
1. Create `PricingCalculator` service class in `src/utils/PricingCalculator.js` that handles all pricing calculations
2. Implement support for multiple pricing methods: absolute price, floor price difference, profit margin, and profit percentage
3. Add comprehensive fee breakdown calculations including marketplace fees and creator royalties
4. Include floor price difference parsing with support for various formats (+0.1, -10%, etc.)
5. Create comprehensive unit tests with >90% coverage for all pricing scenarios and edge cases
6. Follow existing coding standards and integrate with project's BigInt handling patterns

## Tasks / Subtasks

- [ ] Task 1: Create PricingCalculator class structure and initialization (AC: 1)
  - [ ] Define service class with chain configuration dependency injection
  - [ ] Set up constructor with chain config and WETH address
  - [ ] Add constants for fee percentages and pricing methods
  - [ ] Implement basic validation for initialization parameters

- [ ] Task 2: Implement core price calculation methods (AC: 2)
  - [ ] Create `calculateAbsolutePrice()` method for fixed pricing
  - [ ] Implement `calculateFloorDifferencePrice()` with floor price lookup
  - [ ] Add `calculateProfitMarginPrice()` using purchase price history
  - [ ] Create `calculateProfitPercentPrice()` for percentage-based margins
  - [ ] Implement main `calculateListingPrice()` orchestrator method

- [ ] Task 3: Add fee breakdown calculations (AC: 3)
  - [ ] Create `calculateFeeBreakdown()` method for comprehensive fee analysis
  - [ ] Implement marketplace fee calculations (default 2.5%)
  - [ ] Add creator royalty calculations with optional royalty support
  - [ ] Calculate net price and effective rates after fees
  - [ ] Support customizable fee parameters

- [ ] Task 4: Implement floor price difference parsing (AC: 4)
  - [ ] Create `parseFloorDifference()` method for various input formats
  - [ ] Support numeric inputs (0.1, -0.05)
  - [ ] Support string formats with signs (+0.1, -10%)
  - [ ] Handle percentage calculations and multipliers
  - [ ] Add validation for invalid formats

- [ ] Task 5: Create comprehensive unit test suite (AC: 5)
  - [ ] Test all pricing calculation methods with various inputs
  - [ ] Test fee breakdown calculations with different scenarios
  - [ ] Test floor price difference parsing for all supported formats
  - [ ] test edge cases and error conditions
  - [ ] Verify >90% code coverage using Jest

- [ ] Task 6: Integration verification and documentation (AC: 6)
  - [ ] Verify BigInt handling follows existing patterns
  - [ ] Ensure proper logger integration for debugging
  - [ ] Add comprehensive JSDoc documentation
  - [ ] Validate integration with ethers.js utilities (parseUnits, formatUnits)

## Dev Notes

### Previous Story Insights
[Source: Analysis of Story 7.1, 7.2, 7.3a, and 7.3b completion]

**Learning from KeyManager Security Refactor (Story 7.1):**
- Proper error handling with custom error types is essential
- Environment variable configuration patterns should be followed
- Class-based services work well with existing architecture

**Learning from Error Handling Refactor (Story 7.2):**
- Consistent error messages across the codebase improve debugging
- Logger should be used instead of console.log for all error reporting
- Input validation should be comprehensive and defensive

**Learning from FlowStateManager (Story 7.3a):**
- Utility classes should be self-contained and reusable
- State management patterns work well for CLI interactions
- Proper testing coverage is critical for utility classes

**Learning from SelectionManager (Story 7.3b):**
- Service classes should handle complex business logic
- Integration with existing CLI patterns is important
- Flexible configuration options improve reusability

### Technical Architecture Context

**PricingCalculator Design Pattern:**
[Source: docs/prd/epic-7-system-refactoring.md#story-73-交互式挂单服务重构]

Based on the epic requirements and original listCommand.js analysis, the PricingCalculator needs to handle:

- **Price calculation logic** extracted from lines 650-850 of listCommand.js
- **Floor price difference calculations** with various input formats
- **Profit margin calculations** (absolute and percentage)
- **Fee breakdown and marketplace fee calculations**
- **Integration with blockchain pricing data**

**Key Functionality Extracted from listCommand.js:**
- `calculateListingPrice()` (~100 lines) - Main price calculation logic
- Floor price lookup and multiplier calculations
- Purchase price history analysis for profit margins
- Fee breakdown and net price calculations

### File Location and Structure
[Source: docs/architecture/source-tree.md]

**Target Location:** `src/utils/PricingCalculator.js`

The utils directory contains utility classes:
- `keyManager.js` - Security and encryption
- `commandUtils.js` - Chain and wallet management
- `configManager.js` - Configuration persistence
- `logger.js` - Logging system
- `proxySetup.js` - Network proxy configuration
- `FlowStateManager.js` - State management (from 7.3a)
- `SelectionManager.js` - Selection logic (from 7.3b)

PricingCalculator should follow the same patterns:
- ES Module exports (export class, export default)
- Proper error handling with logger
- Constructor-based dependency injection
- Comprehensive JSDoc documentation

### Blockchain and Web3 Integration
[Source: docs/architecture/tech-stack.md]

**Key Dependencies:**
- **ethers.js** ^6.15.0 for BigInt operations and utilities
- Chain configuration for WETH addresses and fee structures
- OpenSea API integration for floor price data

**BigInt Handling Patterns:**
[Source: docs/architecture/coding-standards.md]

```javascript
// ✅ Correct BigInt usage
import { parseUnits, formatUnits } from 'ethers';

const amount = parseUnits(amountStr, 18);  // Returns BigInt
const total = amount + fee;  // BigInt arithmetic
logger.info('Amount:', formatUnits(total, 18), 'ETH');

// ❌ Incorrect floating-point usage
const amount = parseFloat(amountStr);  // Precision loss
const total = amount + 0.001;  // Unsafe floating-point arithmetic
```

### Coding Standards
[Source: docs/architecture/coding-standards.md]

**Requirements:**
- Use ES2022 with ES Modules (package.json has `"type": "module"`)
- Follow camelCase file naming (`PricingCalculator.js`)
- Use PascalCase for class names (`class PricingCalculator`)
- Use logger from `src/utils/logger.js` - never console.log
- Proper BigInt handling for all monetary calculations
- Add comprehensive JSDoc comments for public methods

**File Structure Pattern:**
```javascript
// src/utils/PricingCalculator.js
import logger from './logger.js';
import { parseUnits, formatUnits } from 'ethers';

export class PricingCalculator {
  constructor(chainConfig) {
    this.chainConfig = chainConfig;
    this.wethAddress = chainConfig.wethAddress;
  }

  // public methods
}

export default PricingCalculator;
```

### Testing Requirements
[Source: docs/architecture/testing.md]

**Test File Location:** `src/__tests__/PricingCalculator.test.js`

**Testing Standards:**
- Use Jest framework with experimental VM modules
- Achieve >90% code coverage
- Mock ethers.js utilities for consistent testing
- Test all pricing methods with various inputs
- Test edge cases and error conditions

**Mock Strategy for Testing:**
```javascript
// Mock ethers.js utilities
jest.mock('ethers', () => ({
  parseUnits: jest.fn(value => BigInt(value) * BigInt(10 ** 18)),
  formatUnits: jest.fn(value => (Number(value) / 10 ** 18).toString())
}));

import { parseUnits, formatUnits } from 'ethers';
```

**Test Structure Example:**
```javascript
describe('PricingCalculator', () => {
  let pricingCalculator;
  let mockChainConfig;

  beforeEach(() => {
    mockChainConfig = {
      wethAddress: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',
      name: 'ethereum'
    };
    pricingCalculator = new PricingCalculator(mockChainConfig);
  });

  describe('calculateAbsolutePrice', () => {
    it('should calculate absolute price correctly', () => {
      // test implementation
    });
  });
});
```

### Data Models and Pricing Structures
[Source: listCommand.js analysis and architecture documentation]

**Price Calculation Result Structure:**
```javascript
{
  price: BigInt,           // Final price in wei
  displayPrice: number,    // Human-readable price in ETH
  method: string,          // Pricing method used
  calculation: string,     // Human-readable calculation description
  // Additional fields based on method:
  floorPrice?: number,     // Floor price for floor-difference method
  floorDiff?: string,      // Floor difference input
  purchasePrice?: number,  // Purchase price for profit methods
  profitMargin?: number,   // Profit margin amount
  profitPercent?: number   // Profit percentage
}
```

**Fee Breakdown Structure:**
```javascript
{
  listingPrice: BigInt,           // Total listing price
  marketplaceFee: {
    percentage: number,           // Fee percentage (e.g., 0.025)
    amount: BigInt               // Fee amount in wei
  },
  creatorRoyalty: {
    percentage: number,           // Royalty percentage
    amount: BigInt,              // Royalty amount in wei
    optional: boolean            // Whether royalty is optional
  },
  totalFees: BigInt,             // Total fees in wei
  netPrice: BigInt,              // Net price after fees
  effectiveRate: number          // Net price percentage of listing price
}
```

### Project Structure Alignment
[Source: docs/architecture/source-tree.md]

**Dependencies and Imports:**
- Should import logger from `./logger.js` (sibling utility)
- Should import ethers utilities for BigInt operations
- Can import chain configuration from `../constants/chains.js`
- Should not import from services layer (maintain dependency direction)
- Should be importable by commands and services

**Integration Points:**
- Will be used by future InteractiveListingService (Story 7.3d)
- May be used by other commands requiring price calculations
- Should be designed as a reusable utility across the application
- Should integrate with existing ethers.js patterns

### Pricing Method Specifications

**1. Absolute Pricing:**
- Input: Fixed price in ETH (e.g., 1.5)
- Output: Direct conversion to wei using parseUnits

**2. Floor Price Difference:**
- Input: Difference from floor price (e.g., +0.1, -10%, 1.1)
- Process: Parse difference → Get floor price → Apply multiplier
- Output: Calculated price in wei

**3. Profit Margin (Absolute):**
- Input: Profit margin in ETH (e.g., 0.5)
- Process: Find purchase price → Add profit margin
- Output: Calculated price in wei

**4. Profit Percentage:**
- Input: Profit percentage (e.g., 20 for 20%)
- Process: Find purchase price → Calculate percentage → Add to purchase
- Output: Calculated price in wei

### Error Handling and Validation

**Input Validation:**
- Validate pricing method is supported
- Validate numeric inputs are positive where appropriate
- Validate floor difference format is parseable
- Validate purchase price exists for profit calculations

**Error Scenarios:**
- Invalid pricing method
- Floor price not available for floor-difference method
- Purchase price not found for profit calculations
- Invalid floor difference format
- Negative resulting prices

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation for PricingCalculator service | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be populated by development agent]

### Debug Log References
[To be populated by development agent]

### Completion Notes List
[To be populated by development agent]

### File List
**Files to Create:**
- `src/utils/PricingCalculator.js` - Main PricingCalculator service class
- `src/__tests__/PricingCalculator.test.js` - Comprehensive unit test suite

**Files to Reference:**
- `src/utils/logger.js` - For logging functionality
- `src/commands/listCommand.js` - For existing pricing patterns to extract
- `src/constants/chains.js` - For chain configuration
- `docs/architecture/` for design patterns and standards

## QA Results
[To be populated by QA agent after implementation]