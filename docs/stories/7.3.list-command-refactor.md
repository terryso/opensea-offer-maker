# Story 7.3: List Command Refactor - Behavior-Preserving Internal Modularization

## Status
Draft

## Story
**As a** developer,
**I want** the `list` command to be internally refactored with strict behavior preservation,
**so that** maintenance and testing are easier without any change to CLI UX

## Acceptance Criteria
1. `src/commands/listCommand.js` 收敛至 <300 行，仍作为 orchestrator；对外 CLI 接口/选项/帮助/默认值完全不变
2. 不新增抽象层（不创建新的类/Service/Manager）；仅进行“文件拆分/函数提取”
3. 定价计算逻辑提取到 `src/listing/pricing.js` 纯函数，保持精度与错误路径完全不变
4. 选择与交互流程提取到 `src/listing/interactiveFlow.js` 纯函数，保留 `BACK_SIGNAL`/`CANCEL_SIGNAL`、分页与提示文案完全不变
5. 复用既有 `src/utils/FlowStateManager.js`，不修改导出与行为；`--skip-confirm` 的处理顺序完全不变
6. 新增 `src/listing/*.js` 纯函数模块具备完整单元测试；现有命令测试（如 `src/__tests__/commands/listCommand.test.js`）保持原样通过
7. 用户可见输出逐字一致（含 emoji/空格/换行/顺序）且退出码触发条件不变；`npm start -- list --help` 输出与重构前完全一致；OpenSea/链交互调用序列、参数与回退（floor/last-sale/fees）不变

## Tasks / Subtasks

- [ ] Extract pricing functions into `src/listing/pricing.js` (AC: 3)
  - [ ] Move and preserve `calculateListingPrice(...)` logic and precision (`toFixed(6)` → `parseFloat`) [Source: architecture/testing.md]
  - [ ] Unit tests for absolute, floor-diff, profit-margin, profit-percent and error paths [Source: architecture/testing.md]
  - [ ] Keep OpenSea collection stats usage unchanged [Source: architecture/external-apis.md#opensea-api-v2]

- [ ] Extract fee calculation into `src/listing/fees.js`
  - [ ] Preserve fallback and logging behavior exactly
  - [ ] Unit tests for normal and fallback paths [Source: architecture/testing.md]

- [ ] Extract expiration parsing/formatting into `src/listing/expiration.js`
  - [ ] Preserve regex `^(\d+)([dhm])$` validation and display formatting
  - [ ] Unit tests for valid/invalid cases [Source: architecture/testing.md]

- [ ] Extract selection/interactive steps into `src/listing/interactiveFlow.js` (AC: 4)
  - [ ] Preserve prompts, pagination, `BACK_SIGNAL`/`CANCEL_SIGNAL`, and step ordering exactly
  - [ ] Provide dependency injection for prompt to enable mocking [Source: architecture/testing.md]

- [ ] Extract confirmation flows into `src/listing/confirmation.js` (AC: 4, 7)
  - [ ] Preserve `confirmListingStep(...)` and `confirmListing(...)` outputs, ordering, emojis
  - [ ] Ensure fee breakdown formatting and optional royalties messaging identical
  - [ ] Unit tests with mocked logger to assert message strings [Source: architecture/coding-standards.md]

- [ ] Extract CLI validations into `src/listing/validation.js`
  - [ ] Preserve mutually exclusive rules and error messages (interactive vs address/tokenId; pricing option exclusivity; marketplaces; expiration)

- [ ] Extract signals into `src/listing/signals.js`
  - [ ] Export `BACK_SIGNAL`, `CANCEL_SIGNAL` without behavior change

- [ ] Keep `src/commands/listCommand.js` as orchestrator only (AC: 1, 2)
  - [ ] Reduce to <300 lines by delegating to extracted modules [Source: architecture/coding-standards.md]
  - [ ] Preserve logging and error handling order and wording [Source: architecture/coding-standards.md]

- [ ] Preserve CLI interface and outputs exactly (AC: 7)
  - [ ] `--help` output identical (description, options, defaults)
  - [ ] Golden-sample equivalence checks for typical success/error paths [Source: architecture/testing.md]

- [ ] Tests (AC: 6)
  - [ ] Unit tests for extracted modules with mocks for external calls [Source: architecture/testing.md]
  - [ ] Maintain existing command tests unchanged and passing [Source: architecture/testing.md]

## Dev Notes

### Previous Story Insights
No specific guidance found in architecture docs

### Data Models
No specific guidance found in architecture docs

### API Specifications
- OpenSea API v2 usage remains unchanged (collections, stats, orders) [Source: architecture/external-apis.md#opensea-api-v2]

### Component Specifications
No specific guidance found in architecture docs

### File Locations
- `src/commands/listCommand.js` (orchestrator only)
- `src/listing/pricing.js`
- `src/listing/fees.js`
- `src/listing/expiration.js`
- `src/listing/interactiveFlow.js`
- `src/listing/confirmation.js`
- `src/listing/validation.js`
- `src/listing/signals.js`
- `src/utils/FlowStateManager.js` (reuse as-is)

### Project Structure Notes
- Align new modules under `src/listing/` and reuse utils under `src/utils/` as per layered architecture [Source: architecture/source-tree.md#分层架构]
- Export command from `src/commands/index.js` unchanged [Source: architecture/source-tree.md#目录树（当前实际状态）]

### AC→实现映射（不新增抽象层，严格“仅文件拆分”）
- **AC2 InteractiveListingService** → 由 `src/commands/listCommand.js` 现有 orchestrator + `src/listing/interactiveFlow.js` 等函数模块协作满足；不创建新类/服务。
- **AC3 PricingCalculator** → 由 `src/listing/pricing.js` 纯函数实现，保持精度与错误路径一致。
- **AC4 SelectionManager** → 由 `src/listing/interactiveFlow.js` 中的 `select*/input*` 步骤函数满足；保留提示/分页/返回/取消逻辑。
- **AC5 FlowStateManager** → 复用 `src/utils/FlowStateManager.js`，不修改导出与行为。

### Env Requirements
- `OPENSEA_API_KEY` [Source: architecture/external-apis.md#opensea-api-v2; architecture/coding-standards.md#环境变量]
- `ALCHEMY_API_KEY` [Source: architecture/external-apis.md#alchemy-rpc; architecture/coding-standards.md#环境变量]

### Behavior Freeze Constraints
- 不新增三方依赖；不变更 CLI 选项/默认值/帮助输出。
- 所有用户可见文案（含 emoji/空格/换行/顺序）逐字一致；日志级别与顺序保持不变。
- 退出码触发条件保持不变（交互取消 0；错误 1）。

### Testing
- Unit tests in `src/__tests__/` with Jest; mock external dependencies; target 80%+ coverage [Source: architecture/testing.md]
- Prefer unit tests for pure functions; integration tests optional (CI currently limited) [Source: architecture/testing.md]

#### Key Scenarios (Golden Samples & Errors)
- 互斥参数：`--interactive` vs `--address/--token-id`（错误文案与顺序一致）
- 定价选项互斥：`--price | --floor-diff | --profit-margin | --profit-percent`（边界与错误提示）
- `--marketplaces` 非 `opensea` 报错路径
- `--expiration` 不匹配 `^(\d+)([dhm])$` 的报错路径
- floor/last-sale/fees 获取失败时的回退与日志输出
- 交互流程：分页/返回/取消（`BACK_SIGNAL`/`CANCEL_SIGNAL`）
- `--skip-confirm` 后置处理
- `npm start -- list --help` 输出完全一致（描述/选项/默认值）

### Technical Constraints
- Use `logger.*` instead of `console.log`; keep existing messaging [Source: architecture/coding-standards.md#日志规范]
- Catch errors in commands and `process.exit(1)` on failure [Source: architecture/coding-standards.md#错误处理]
- Do not hardcode API keys; use centralized config/env access [Source: architecture/coding-standards.md#环境变量]
- Avoid code duplication; extract shared logic to services/utils [Source: architecture/technical-debt.md#6-代码重复---fetchwithretry]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation (template-aligned) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References
- N/A (to be filled by Dev Agent during implementation)

### Completion Notes List
- N/A (to be filled by Dev Agent during implementation)

### File List
- N/A (to be filled by Dev Agent during implementation)

## QA Results

To be completed by QA Agent after implementation.
